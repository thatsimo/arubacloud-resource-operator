name: Pull Request

on:
    pull_request:
        types: [opened, synchronize, reopened]
        branches: [main, develop]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    changes:
        name: Detect Changes
        runs-on: ubuntu-latest
        outputs:
            go: ${{ steps.changes.outputs.go }}
            docs: ${{ steps.changes.outputs.docs }}
            config: ${{ steps.changes.outputs.config }}
        steps:
            - uses: actions/checkout@v4
            - uses: dorny/paths-filter@v3
              id: changes
              with:
                  filters: |
                      go:
                        - '**/*.go'
                        - 'go.mod'
                        - 'go.sum'
                        - 'Makefile'
                        - 'Dockerfile'
                      docs:
                        - '**/*.md'
                        - 'docs/**'
                      config:
                        - '.github/**'
                        - '.golangci.yml'
                        - 'config/**'

    lint-and-test:
        name: Lint and Test
        runs-on: ubuntu-latest
        needs: changes
        if: needs.changes.outputs.go == 'true'
        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.24"

            - name: Cache Go modules
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Download dependencies
              run: go mod download

            - name: Run golangci-lint
              uses: golangci/golangci-lint-action@v6
              with:
                  version: v1.60.3
                  args: --timeout=5m --config=.golangci.yml

            - name: Generate code and manifests
              run: make generate manifests

            - name: Verify no changes
              run: |
                  git diff --exit-code || (echo "Generated files are not up to date. Please run 'make generate manifests' and commit the changes." && exit 1)

            - name: Build
              run: make build

            - name: Run tests
              run: make test

            - name: Upload coverage
              uses: codecov/codecov-action@v4
              with:
                  file: ./cover.out
                  flags: unittests
                  name: codecov-pr

    build-image:
        name: Build Image
        runs-on: ubuntu-latest
        needs: changes
        if: needs.changes.outputs.go == 'true'
        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build container image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: false
                  tags: arubacloud-resource-operator:pr-${{ github.event.number }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        needs: changes
        if: needs.changes.outputs.go == 'true'
        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.24"

            - name: Run Gosec Security Scanner
              uses: securecodewarrior/github-action-gosec@master
              with:
                  args: "-no-fail -fmt sarif -out gosec.sarif ./..."

            - name: Upload SARIF file
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: gosec.sarif

    validate-config:
        name: Validate Configuration
        runs-on: ubuntu-latest
        needs: changes
        if: needs.changes.outputs.config == 'true'
        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.24"

            - name: Validate Kubernetes manifests
              run: |
                  make manifests
                  # Validate CRDs
                  for file in config/crd/bases/*.yaml; do
                    echo "Validating $file"
                    kubectl --dry-run=client apply -f "$file" || exit 1
                  done

            - name: Validate golangci-lint config
              run: |
                  go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.60.3
                  golangci-lint config verify

    pr-summary:
        name: PR Summary
        runs-on: ubuntu-latest
        needs:
            [
                changes,
                lint-and-test,
                build-image,
                security-scan,
                validate-config,
            ]
        if: always()
        steps:
            - name: PR Summary
              run: |
                  echo "## ðŸ” Pull Request Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Changes Detected:" >> $GITHUB_STEP_SUMMARY
                  echo "- Go code: ${{ needs.changes.outputs.go }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Documentation: ${{ needs.changes.outputs.docs }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Configuration: ${{ needs.changes.outputs.config }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Job Results:" >> $GITHUB_STEP_SUMMARY
                  echo "- Lint & Test: ${{ needs.lint-and-test.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Build Image: ${{ needs.build-image.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Config Validation: ${{ needs.validate-config.result }}" >> $GITHUB_STEP_SUMMARY
